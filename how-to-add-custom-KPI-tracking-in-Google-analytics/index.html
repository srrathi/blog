<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/blog/styles.48aeaa0e7046f5829e35.css">.header-module--header--ZHkmL{display:flex;flex-flow:column;width:100%}.header-module--title--2lV1C{text-weight:bold;margin-top:1.5rem}.header-module--nav-list--2kP4E{list-style:none;display:flex;flex-flow:row wrap;width:100%;align-items:flex-end;justify-content:flex-end;margin:0 0 1.5rem}.header-module--nav-item--2iLRZ{text-decoration:none;color:#999;font-size:.9rem;margin-right:1.3rem}.header-module--nav-item--2iLRZ::hover{color:#666}.header-module--active-nav-item--1hcBS{color:#333}.footer-module--footer--1X2XH{border-top:.3rem dashed #ededed;margin-top:3rem;font-family:monospace;display:flex;flex-direction:column;align-items:center}.footer-module--footer--1X2XH p{font-size:.8rem;margin-top:1rem}.footer-module--newsletter--1OTuc{width:100%;min-height:5rem;padding:.2rem 0;display:flex;align-items:center;justify-content:center}.footer-module--newsletter--1OTuc form{margin:0;display:flex;flex-flow:row wrap;align-items:center;justify-content:center}.footer-module--newsletter--1OTuc form input[type=email]{min-width:300px}.footer-module--newsletter--1OTuc form input[type=submit]{color:#e3f5f6;box-shadow:none;border-radius:8px;background-color:#bc05e2;font-family:Roberto;min-height:2rem}.footer-module--hide--3OCkg{display:none}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}nav hr,p,ul{margin:0;padding:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:sans-serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.38316rem;line-height:1.1}h4{font-size:1rem}h4,h5{padding:0;margin:0 0 .5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h5{font-size:.85028rem}h6{padding:0;margin:0 0 .5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:.78405rem;line-height:1.1}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}.layout-module--root--M0IDY{display:flex;width:100%;justify-content:center}.layout-module--outer-container--3IvoK{width:75%}@media only screen and (max-width:480px){.layout-module--outer-container--3IvoK{width:90%}}.layout-module--container--1kYBq{display:flex;flex-flow:column;min-height:100vh;width:100%}.layout-module--content--3V5Vv{flex-grow:1}.blogPost-module--header--1VPds{margin-bottom:2rem;padding:.1rem 0 .8rem;border-bottom:2px solid #000;display:flex;flex-direction:column}.blogPost-module--title--2VjOr{margin:0 0 .6rem}.blogPost-module--tag-list--340wz{list-style:none;display:flex;margin:0;padding:1px 2px}.blogPost-module--tag-list--340wz .blogPost-module--tag--2hrjm{margin-right:7px;color:#411604;background:#95d6f6;padding:0 5px;border-radius:5px;font-size:.8rem}.blogPost-module--content--2oaej h2{font-family:Times New Roman,Times,serif;color:#3e3e46}.blogPost-module--content--2oaej h2 em{font-size:1.4rem}.blogPost-module--content--2oaej h4{font-size:1.2rem;font-weight:400}.blogPost-module--content--2oaej p{color:#555}.blogPost-module--content--2oaej p i{color:#5c5c5c}.blogPost-module--content--2oaej p b{color:#353535}.blogPost-module--content--2oaej p code{color:#4c4c4c}.blogPost-module--content--2oaej a{text-decoration:none;color:#1250c8}.blogPost-module--content--2oaej a:hover{color:#13095e}.blogPost-module--content--2oaej blockquote{padding-left:1rem;border-left:5px solid #dadae7}.about-module--link--F7iYP{text-decoration:none;color:#1250c8;font-size:.9rem}.index-module--list--1JDC9{margin:0;padding:0 1vw;list-style:none;display:flex;align-items:flex-start;flex-direction:column;justify-content:flex-start}.index-module--list--1JDC9 a{text-decoration:none;margin:0;width:100%;height:100%}.index-module--list-item--xMexI{background:#fdf8e5;border-radius:3px;width:100%;height:100%;padding:.5rem;min-height:5.5rem;transition:.2s;margin-bottom:1.5rem;display:flex;flex-direction:column;justify-content:space-around}.index-module--list-item--xMexI:hover{transform:translateX(-5px)}.index-module--title--3t_ss{font-size:1.5rem;margin:0;color:#000}.index-module--date--1e2YA{color:#999;font-size:.8rem;text-align:right;margin-right:5px;margin-top:3px}</style><meta name="generator" content="Gatsby 2.24.56"/><title data-react-helmet="true">How to track custom KPIs with Google Analytics | Let&#x27;s Learn Together!</title><link as="script" rel="preload" href="/blog/webpack-runtime-018fc706c25fd62c7bb3.js"/><link as="script" rel="preload" href="/blog/framework-fd2b85530eec85104a39.js"/><link as="script" rel="preload" href="/blog/app-240368e995a3fecb3f33.js"/><link as="script" rel="preload" href="/blog/styles-c2fe8482057191dca484.js"/><link as="script" rel="preload" href="/blog/commons-73ab4830656fb9fb701b.js"/><link as="script" rel="preload" href="/blog/component---src-components-templates-blog-post-js-d318cdff71f41fc4e0ff.js"/><link as="fetch" rel="preload" href="/blog/page-data/how-to-add-custom-KPI-tracking-in-Google-analytics/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/2199005656.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/3159585216.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--root--M0IDY"><div class="layout-module--outer-container--3IvoK"><div class="layout-module--container--1kYBq"><div id="content" class="layout-module--content--3V5Vv"><header class="header-module--header--ZHkmL"><h1 class="header-module--title--2lV1C">Let&#x27;s Learn Together!</h1><nav><ul class="header-module--nav-list--2kP4E"><li><a class="header-module--nav-item--2iLRZ" href="/blog/">Home</a></li><li><a class="header-module--nav-item--2iLRZ" href="/blog/about">About</a></li></ul></nav></header><div class="blogPost-module--header--1VPds"><h1 class="blogPost-module--title--2VjOr">How to track custom KPIs with Google Analytics</h1><ol class="blogPost-module--tag-list--340wz"><li class="blogPost-module--tag--2hrjm"><i>API</i></li><li class="blogPost-module--tag--2hrjm"><i>Google Analytics</i></li><li class="blogPost-module--tag--2hrjm"><i>AJAX</i></li></ol></div><div class="blogPost-module--content--2oaej"><blockquote>
<p>TL;DR: I sent data through an AJAX request to an end point of google analytics. Follow <a href="/blog/send-custom-events-to-google-analytics">this article</a> for step-by-step instructions</p>
</blockquote>
<h2>The task that I was trying to complete</h2>
<p>I needed a away to get a analytics report for the number of users whose premium plan is active on a particular day. This would then become a company KPI for the product.</p>
<h2>First approach <em>TL;DR: Didn't Work</em></h2>
<p>We had all our customer data on firebase real time database. After some digging, I found that firebase too has an analytics dashboard called firebase analytics and that we could set custom user properties. These custom properties could then be used to make audiences that we wanted to monitor.
The approach that I decided to take was that I could make a custom property called <code>isPremiunActive</code> for each and every user and run a scheduled firebase function everyday, that would traverse through all the premium users and set this property on their profile as <code>true</code> if their plan has not yet expired, else it would set it to false.
<em>Later we would change to function to only set things to false as we would set it to true when ever the user buys a new plan</em></p>
<h4>Why it did not work</h4>
<p>The firebase SDK method <code>setUserProperty</code>, that was supposed to set the value of this custom user property, did not take any parameters like user ID or email or any such argument that could let us tell the function about the user we are targeting. After a few hours of reading the docs and contacting firebase support, I came to know that this method was only supposed to used within the app (<em>during a logged in session</em>) and the user was identified by the authentication details stored in the firebase SDK.</p>
<blockquote>
<p>Firebase support, if you are reading this(<em>highly unlikely</em>), I was very happy that you responded to my queries very quickly and thoroughly. They helped me understand what the firebase analytics feature was actually meant for and how it is not for my needs.</p>
</blockquote>
<h2>Second approach <em>The title of the article. Let's answer the how</em></h2>
<p>I started searching for a way to raise custom events on Google analytics using some API in my firebase functions. At first, the only API that I could find was the <code>Google Analytics Reporting V4</code>.
This API was pitched everywhere as a way to get analytics data by performing all sorts of complex queries (<em>thanks to the number of query parameters that it provides. THERE ARE A TON!</em>)
But you might wonder that if you can only get data then this API does not solve our problem, and you are right. The only reason I even considered exploring it was because the only endpoint that it had handled post requests (<em>Little did I know that <code>POST</code> does not always mean sending data to be stored somewhere you want</em>) </p>
<p>At this point I had lost all hopes and decided that I would just store the data for each day on firebase (<em>In a somewhat ordered fashion for now</em>) and get the data from there. Later, we could send all this data to <strong>Google Data Studio</strong> to get a more graphical understanding to the data.</p>
<h4>Something good finally happened (<em>well maybe not good, but.... you'll see</em>)</h4>
<p>Our main company product is a web app which, to work in the background and regular work-flow, also has a browser extension. During all this hassle we were at the point of releasing a new version of the app.
While we were in the process of updating the extension for Firefox, the review report by Firefox did not approve the current version of the app for certain reasons. The good part was that they sent a thorough report of why they did not approve it and how to fix the problems. In the report there was a link pointing to an article titled <a href="https://blog.mozilla.org/addons/2016/05/31/using-google-analytics-in-extensions/">Using Google Analytics in extensions</a></p>
<p><strong>Following is an excerpt from the article</strong></p>
<blockquote>
<p>This blog post is meant to show the safer ways of using GA, not advocate its unrestricted use.</p>
</blockquote>
<blockquote>
<p>I created a branch of one of my add-ons to serve as a demo. The add-on is a WebExtension that injects a content script into some AMO pages to add links that are useful to admins and reviewers. The diff for the branch shouldn’t take much time to read and understand. It mostly comes down to this XHR:</p>
</blockquote>
<pre><code>let request = new XMLHttpRequest();
let message =
  "v=1&#x26;tid=" + GA_TRACKING_ID + "&#x26;cid= " + GA_CLIENT_ID + "&#x26;aip=1" +
  "&#x26;ds=add-on&#x26;t=event&#x26;ec=AAA&#x26;ea=" + aType;

request.open("POST", "https://www.google-analytics.com/collect", true);
request.send(message);
</code></pre>
<p>I pasted the above script into a new file, and customized it to send function like this</p>
<pre><code>let hitGA = () => {
  const GA_TRACKING_ID = "your GA tracking ID"
  const GA_CLIENT_ID = "steps to get this will be given in the resources below"

  const event = {
    category: "pricing",
    action: "counted",
    label: "num_active_users",
    value: 71
  }
  let request = new XMLHttpRequest();
  let message = 
  `v=1&#x26;tid=${GA_TRACKING_ID}&#x26;cid=${GA_CLIENT_ID}&#x26;aip=1&#x26;ds=add-on&#x26;t=event&#x26;ec=${event.category}&#x26;ea=${event.action}&#x26;el=${event.label}&#x26;ev=${event.value}`

  request.open("POST", "https://www.google-analytics.com/collect", true);
  request.send(message);

}
</code></pre>
<p>And then I copied this whole thing into Firefox's console and <em>volla</em> I got a successful <strong>200 OK</strong> Response. </p>
<p><strong><em>But,</em></strong><br>
The event was not seen in firebase analytics. I thought that this might had been because firebase had applied some sort of filtering system for incoming request to avoid tracking <em>bogus requests</em> like this.
So, frustrated and tired after the day's effort I decided to sleep on it.</p>
<p><strong><em>But,</em></strong><br>
The next day, when I checked Google analytics for the event (<em>with no hope whatsoever</em>) the event was there!!!</p>
<p>Finally!</p>
<p>So I implemented the changes in the firebase function and then tried to test it after deployment. It executed successfully and I got a proper response but again there was no such event in analytics.
Turns out that it takes time to track events on firebase (<em>Why GOOGLE? <strong>WHY?!!</strong></em>)</p>
<p>So, like every good story, I successfully committed the code and the program ran happily ever after.</p>
<h2>Links on the web that helped me get through this problem</h2>
<ol>
<li><a href="https://www.owox.com/blog/use-cases/google-analytics-client-id/">How to find <code>GA_CLIENT_ID</code></a></li>
<li><a href="https://stackoverflow.com/questions/63808048/add-custom-user-property-through-firebase-function">StackOverflow question</a> that I opened</li>
<li><a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events">Docs</a> that were helpful</li>
<li>And of course, <a href="https://blog.mozilla.org/addons/2016/05/31/using-google-analytics-in-extensions/"><strong><em>the lifesaver</em></strong></a></li>
</ol></div></div><footer class="footer-module--footer--1X2XH"><div class="footer-module--newsletter--1OTuc"><form action="https://tinyletter.com/nsr-py" method="post" target="popupwindow"><input type="email" name="email" id="tlemail" placeholder="Subscribe to NewsLetter" required=""/><input type="hidden" value="1" name="embed"/><input type="submit" value="Subscribe" id="button"/></form></div><p>Made with love by <!-- -->Navdeep</p></footer></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/how-to-add-custom-KPI-tracking-in-Google-analytics";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-eb8656802e1a45e48c50.js"],"app":["/app-240368e995a3fecb3f33.js"],"component---src-components-templates-blog-post-js":["/component---src-components-templates-blog-post-js-d318cdff71f41fc4e0ff.js"],"component---src-pages-about-js":["/component---src-pages-about-js-430e7c0e23d153c96487.js"],"component---src-pages-index-js":["/component---src-pages-index-js-aaab3aa7e6ff0ec735e5.js"]};/*]]>*/</script><script src="/blog/polyfill-eb8656802e1a45e48c50.js" nomodule=""></script><script src="/blog/component---src-components-templates-blog-post-js-d318cdff71f41fc4e0ff.js" async=""></script><script src="/blog/commons-73ab4830656fb9fb701b.js" async=""></script><script src="/blog/styles-c2fe8482057191dca484.js" async=""></script><script src="/blog/app-240368e995a3fecb3f33.js" async=""></script><script src="/blog/framework-fd2b85530eec85104a39.js" async=""></script><script src="/blog/webpack-runtime-018fc706c25fd62c7bb3.js" async=""></script></body></html>